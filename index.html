<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trivia APC Madrid</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; background: #f4f4f4; transition: background 0.3s; }
        .dark-mode { background: #222; color: #fff; }
        svg { width: 90vw; height: auto; margin: auto; display: block; }
        .apc { fill: lightgray; stroke: black; stroke-width: 0.5px; cursor: pointer; transition: fill 0.3s ease, transform 0.2s ease; }
        .correct { fill: green !important; }
        .incorrect { fill: red !important; }
        .hidden { display: none; }
        button { padding: 10px; margin: 10px; cursor: pointer; }
    </style>
</head>
<body>

    <h1>Trivia APC Madrid</h1>
    <h2 id="question">Cargando...</h2>
    <p>Puntuaci칩n: <span id="score">0</span> | Aciertos seguidos: <span id="combo">0</span></p>
    <button onclick="toggleDarkMode()">游깿 Modo oscuro</button>
    <button onclick="resetGame()">Reset</button>
    <div id="map-container"></div>

    <script>
        const codes = [
            "28002", "28004", "28006", "28007", "28009", "28013", "28014", "28015", "28022", "28026", "28033", "28040",
            "28041", "28045", "28049", "28052", "28053", "28057", "28058", "28059", "28061", "28065", "28067", "28072",
            "28073", "28074", "28075", "28079", "28080", "28084", "28085", "28086", "28089", "28090", "28091", "28092",
            "28096", "28104", "28106", "28110", "28113", "28115", "28119", "28123", "28127", "28129", "28130", "28132",
            "28134", "28140", "28141", "28147", "28149", "28150", "28152", "28154", "28157", "28161", "28164", "28167",
            "28170", "28172", "28174", "28175", "28176", "28177", "28178", "28181", "28903"
        ];

        const names = [
            "Ajalvir", "El 츼lamo", "Alcobendas", "Alcorc칩n", "Algete", "Aranjuez", "Arganda del Rey", "Arroyomolinos",
            "Boadilla del Monte", "Brunete", "Campo Real", "Ciempozuelos", "Cobe침a", "Colmenar Viejo", "Coslada", "Chinch칩n",
            "Daganzo de Arriba", "Fresno de Torote", "Fuenlabrada", "Fuente el Saz de Jarama", "Galapagar", "Getafe",
            "Guadalix de la Sierra", "Hoyo de Manzanares", "Humanes de Madrid", "Legan칠s", "Loeches", "Madrid", "Majadahonda",
            "Mejorada del Campo", "Miraflores de la Sierra", "El Molar", "Moraleja de Enmedio", "Moralzarzal",
            "Morata de Taju침a", "M칩stoles", "Navalcarnero", "Paracuellos de Jarama", "Parla", "Perales de Taju침a",
            "Pinto", "Pozuelo de Alarc칩n", "Quijorna", "Rivas-Vaciamadrid", "Las Rozas de Madrid",
            "San Agust칤n del Guadalix", "San Fernando de Henares", "San Mart칤n de la Vega",
            "San Sebasti치n de los Reyes", "Serranillos del Valle", "Sevilla la Nueva", "Titulcia",
            "Torrej칩n de la Calzada", "Torrej칩n de Velasco", "Torrelodones", "Torres de la Alameda",
            "Valdelaguna", "Valdemoro", "Valdetorres de Jarama", "Velilla de San Antonio",
            "Villaconejos", "Villalbilla", "Villamanta", "Villamantilla", "Villanueva de la Ca침ada",
            "Villanueva del Pardillo", "Villanueva de Perales", "Villaviciosa de Od칩n", "Tres Cantos"
        ];

        let attempts = 0;
        let remaining = JSON.parse(localStorage.getItem("remaining")) || [...names].sort(() => Math.random() - 0.5);
        let current = localStorage.getItem("current") || null;
        let score = parseInt(localStorage.getItem("score")) || 0;
        let combo = parseInt(localStorage.getItem("combo")) || 0;

        function updateUI() {
            document.getElementById("score").innerText = score;
            document.getElementById("combo").innerText = combo;
        }

        function nextQuestion() {
            if (remaining.length > 0) {
                attempts = 0;
                current = remaining.pop();
                localStorage.setItem("remaining", JSON.stringify(remaining));
                localStorage.setItem("current", current);
                document.getElementById("question").innerText = `Haz clic en: ${current}`;
            } else {
                document.getElementById("question").innerText = "춰Juego terminado!";
            }
        }

        function toggleDarkMode() {
            document.body.classList.toggle("dark-mode");
            localStorage.setItem("darkMode", document.body.classList.contains("dark-mode"));
        }

        function resetGame() {
            remaining = [...names].sort(() => Math.random() - 0.5);
            localStorage.removeItem("remaining");
            localStorage.removeItem("current");
            localStorage.setItem("score", "0");
            localStorage.setItem("combo", "0");
            score = 0;
            combo = 0;
            updateUI();
            nextQuestion();
        }

        document.addEventListener("DOMContentLoaded", () => {
            if (localStorage.getItem("darkMode") === "true") {
                document.body.classList.add("dark-mode");
            }
            updateUI();
            nextQuestion();
        });

        fetch("mapa.svg")
            .then(response => response.text())
            .then(svgData => {
                document.getElementById("map-container").innerHTML = svgData;
                let svg = d3.select("#map-container svg");

                svg.selectAll("path").filter(function() {
                    return codes.includes(this.getAttribute("id")?.substring(0, 5));
                }).classed("apc", true);

                svg.on("click", function(event) {
                    let target = event.target;
                    let selected = target.getAttribute("id")?.substring(0, 5);
                    if (!selected || !codes.includes(selected)) return;

                    if (names[codes.indexOf(selected)] === current) {
                        target.classList.add("correct");
                        score += 10;
                        combo++;
                        localStorage.setItem("score", score);
                        localStorage.setItem("combo", combo);
                        updateUI();
                        setTimeout(nextQuestion, 5000);
                    } else if (++attempts >= 3) {
                        let correctIndex = names.indexOf(current);
                        let correctCode = codes[correctIndex];
                        svg.select(`[id^="${correctCode}"]`).classed("correct", true);
                        setTimeout(nextQuestion, 5000);
                    }
                });

                nextQuestion();
            })
            .catch(error => console.error("Error cargando el mapa:", error));
    </script>

</body>
</html>
