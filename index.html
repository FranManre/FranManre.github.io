<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trivia APC Madrid</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; background: #f4f4f4; transition: background 0.3s; }
        .dark-mode { background: #222; color: #fff; }
        svg { width: 90vw; height: auto; margin: auto; display: block; }
        .apc { fill: lightgray; stroke: black; stroke-width: 0.5px; cursor: pointer; transition: fill 0.3s ease, transform 0.2s ease; }
        .correct { fill: green !important; }
        .incorrect { fill: red !important; }
        .highlight { fill: yellow !important; }
        .hidden { display: none; }
        button { padding: 10px; margin: 10px; cursor: pointer; }
    </style>
</head>
<body>

    <h1>Trivia APC Madrid</h1>
    <h2 id="question">Cargando...</h2>
    <p>PuntuaciÃ³n: <span id="score">0</span> | Aciertos seguidos: <span id="combo">0</span></p>
    <button onclick="toggleDarkMode()">ðŸŒ™ Modo oscuro</button>
    <button onclick="resetGame()">Reset</button>
    <div id="map-container"></div>

    <script>
        const codes = [...];  // Tus cÃ³digos aquÃ­
        const names = [...];  // Tus nombres aquÃ­

        let attempts = 0;
        let remaining = JSON.parse(localStorage.getItem("remaining")) || [...names].sort(() => Math.random() - 0.5);
        let current = localStorage.getItem("current") || null;
        let score = parseInt(localStorage.getItem("score")) || 0;
        let combo = parseInt(localStorage.getItem("combo")) || 0;

        function updateUI() {
            document.getElementById("score").innerText = score;
            document.getElementById("combo").innerText = combo;
        }

        function nextQuestion() {
            if (remaining.length > 0) {
                attempts = 0;
                current = remaining.pop();
                localStorage.setItem("remaining", JSON.stringify(remaining));
                localStorage.setItem("current", current);
                document.getElementById("question").innerText = `Haz clic en: ${current}`;
                enableClicks(true);
            } else {
                document.getElementById("question").innerText = "Â¡Juego terminado!";
            }
        }

        function toggleDarkMode() {
            document.body.classList.toggle("dark-mode");
            localStorage.setItem("darkMode", document.body.classList.contains("dark-mode"));
        }

        function resetGame() {
            remaining = [...names].sort(() => Math.random() - 0.5);
            localStorage.removeItem("remaining");
            localStorage.removeItem("current");
            localStorage.setItem("score", "0");
            localStorage.setItem("combo", "0");
            score = 0;
            combo = 0;
            updateUI();
            nextQuestion();
        }

        function enableClicks(state) {
            document.getElementById("map-container").style.pointerEvents = state ? "auto" : "none";
        }

        document.addEventListener("DOMContentLoaded", () => {
            if (localStorage.getItem("darkMode") === "true") {
                document.body.classList.add("dark-mode");
            }
            updateUI();
            nextQuestion();
        });

        fetch("mapa.svg")
            .then(response => response.text())
            .then(svgData => {
                document.getElementById("map-container").innerHTML = svgData;
                let svg = d3.select("#map-container svg");

                svg.selectAll("path").filter(function() {
                    return codes.includes(this.getAttribute("id")?.substring(0, 5));
                }).classed("apc", true);

                svg.on("click", function(event) {
                    let target = event.target;
                    let selected = target.getAttribute("id")?.substring(0, 5);
                    if (!selected || !codes.includes(selected)) return;

                    if (names[codes.indexOf(selected)] === current) {
                        enableClicks(false);
                        target.classList.add("correct");
                        score += 10;
                        combo++;
                        localStorage.setItem("score", score);
                        localStorage.setItem("combo", combo);
                        updateUI();
                        setTimeout(() => {
                            target.classList.remove("correct");
                            nextQuestion();
                        }, 5000);
                    } else {
                        attempts++;
                        target.classList.add("incorrect");
                        setTimeout(() => target.classList.remove("incorrect"), 2000);

                        if (attempts >= 3) {
                            enableClicks(false);
                            let correctIndex = names.indexOf(current);
                            let correctCode = codes[correctIndex];
                            let correctElement = svg.select(`[id^="${correctCode}"]`).node();

                            if (correctElement) {
                                correctElement.classList.add("correct");
                                setTimeout(() => {
                                    correctElement.classList.remove("correct");
                                    nextQuestion();
                                }, 5000);
                            } else {
                                nextQuestion();
                            }
                        }
                    }
                });

                nextQuestion();
            })
            .catch(error => console.error("Error cargando el mapa:", error));
    </script>

</body>
</html>
