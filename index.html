<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trivia APC Madrid</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; background: #f4f4f4; transition: background 0.3s; }
        .dark-mode { background: #222; color: #fff; }
        svg { width: 90vw; height: auto; margin: auto; display: block; }
        .apc { fill: lightgray; stroke: black; stroke-width: 0.5px; cursor: pointer; transition: fill 0.3s ease, transform 0.2s ease; }
        .correct { fill: green !important; }
        .incorrect { fill: red !important; }
        .highlight { fill: yellow !important; }
        .hidden { display: none; }
        button { padding: 10px; margin: 10px; cursor: pointer; }
    </style>
</head>
<body>

    <h1>Trivia APC Madrid</h1>
    <h2 id="pregunta">Cargando...</h2>
    <p>Puntuación: <span id="score">0</span> | Aciertos seguidos: <span id="combo">0</span></p>
    <button onclick="toggleModoOscuro()">🌙 Modo oscuro</button>
    <button onclick="reset()">Reset</button>
    <div id="map-container"></div>
    <p id="logro" class="hidden">🏆 ¡Logro desbloqueado!</p>

    <script>
        const municipiosAPC = {
            "28002": "Ajalvir", "28004": "El Álamo", "28006": "Alcobendas", "28007": "Alcorcón",
            "28009": "Algete", "28013": "Aranjuez", "28014": "Arganda del Rey", "28015": "Arroyomolinos",
            "28022": "Boadilla del Monte", "28026": "Brunete", "28033": "Campo Real", "28040": "Ciempozuelos",
            "28041": "Cobeña", "28045": "Colmenar Viejo", "28049": "Coslada", "28052": "Chinchón",
            "28053": "Daganzo de Arriba", "28057": "Fresno de Torote", "28058": "Fuenlabrada",
            "28059": "Fuente el Saz de Jarama", "28061": "Galapagar", "28065": "Getafe",
            "28067": "Guadalix de la Sierra", "28072": "Hoyo de Manzanares", "28073": "Humanes de Madrid",
            "28074": "Leganés", "28075": "Loeches", "28079": "Madrid", "28080": "Majadahonda",
            "28084": "Mejorada del Campo", "28085": "Miraflores de la Sierra", "28086": "El Molar",
            "28089": "Moraleja de Enmedio", "28090": "Moralzarzal", "28091": "Morata de Tajuña",
            "28092": "Móstoles", "28096": "Navalcarnero", "28104": "Paracuellos de Jarama",
            "28106": "Parla", "28110": "Perales de Tajuña", "28113": "Pinto", "28115": "Pozuelo de Alarcón",
            "28119": "Quijorna", "28123": "Rivas-Vaciamadrid", "28127": "Las Rozas de Madrid",
            "28129": "San Agustín del Guadalix", "28130": "San Fernando de Henares",
            "28132": "San Martín de la Vega", "28134": "San Sebastián de los Reyes",
            "28140": "Serranillos del Valle", "28141": "Sevilla la Nueva", "28147": "Titulcia",
            "28149": "Torrejón de la Calzada", "28150": "Torrejón de Velasco", "28152": "Torrelodones",
            "28154": "Torres de la Alameda", "28157": "Valdelaguna", "28161": "Valdemoro",
            "28164": "Valdetorres de Jarama", "28167": "Velilla de San Antonio", "28170": "Villaconejos",
            "28172": "Villalbilla", "28174": "Villamanta", "28175": "Villamantilla",
            "28176": "Villanueva de la Cañada", "28177": "Villanueva del Pardillo",
            "28178": "Villanueva de Perales", "28181": "Villaviciosa de Odón", "28903": "Tres Cantos"
        };

        if (localStorage.getItem("dark-mode") === "true") { document.body.classList.toggle("dark-mode"); }
        let intentos = 0;
        let score = localStorage.getItem("score") || 0;
        let combo = localStorage.getItem("combo") || 0;
        let municipiosRestantes = JSON.parse(localStorage.getItem("restantes")) || Object.values(municipiosAPC).sort(() => Math.random() - 0.5);
        let municipioActual = localStorage.getItem("current");

        document.getElementById("score").innerText = score;
        document.getElementById("combo").innerText = combo;

        function siguientePregunta() {
            if (municipiosRestantes.length > 0) {
                intentos = 0;
                municipioActual = municipiosRestantes.pop();
                localStorage.setItem("current", municipioActual);
                document.getElementById("pregunta").innerText = `Haz clic en: ${municipioActual}`;
                localStorage.setItem("restantes", JSON.stringify(municipiosRestantes));
            } else {
                document.getElementById("pregunta").innerText = "¡Juego terminado!";
            }
        }

        function toggleModoOscuro() {
            document.body.classList.toggle("dark-mode");
            localStorage.setItem("dark-mode", !(localStorage.getItem("dark-mode") === "true"));
        }
        
        function reset() {
            localStorage.setItem("score", score = 0);
            localStorage.setItem("combo", combo = 0);
            municipiosRestantes = Object.values(municipiosAPC).sort(() => Math.random() - 0.5);
            document.getElementById("score").innerText = score;
            document.getElementById("combo").innerText = combo;
            siguientePregunta();
        }

        function mostrarLogro(mensaje) {
            let logro = document.getElementById("logro");
            logro.innerText = mensaje;
            logro.classList.remove("hidden");
            setTimeout(() => logro.classList.add("hidden"), 3000);
        }

        fetch("mapa.svg")
            .then(response => response.text())
            .then(svgData => {
                requestIdleCallback(() => {
                    document.getElementById("map-container").innerHTML = svgData;
                    let svg = d3.select("#map-container svg");
                    svg.selectAll("path").filter(function() {
                        return Object.keys(municipiosAPC).includes(this.getAttribute("id")?.substring(0, 5));
                    }).classed("apc", true);

                    svg.on("click", function(event) {
                        let target = event.target;
                        let municipioSeleccionado = target.getAttribute("id")?.substring(0, 5);

                        if (!municipioSeleccionado || !Object.keys(municipiosAPC).includes(municipioSeleccionado)) return;

                        if (municipiosAPC[municipioSeleccionado] === municipioActual) {
                            target.classList.add("correct");
                            score++;
                            combo++;

                            if (combo === 10) mostrarLogro("🏆 Experto: 10 aciertos seguidos");

                            document.getElementById("score").innerText = score;
                            document.getElementById("combo").innerText = combo;
                            localStorage.setItem("score", score);
                            localStorage.setItem("combo", combo);

                            if ("vibrate" in navigator) navigator.vibrate(100);
                            new Audio("acierto.mp3").play();

                            setTimeout(() => {
                                target.classList.remove("correct");
                                siguientePregunta();
                            }, 3000);
                        } else {
                            intentos++;
                            target.classList.add("incorrect");
                            if ("vibrate" in navigator) navigator.vibrate(300);
                            new Audio("error.mp3").play();

                            setTimeout(() => target.classList.remove("incorrect"), 2000);

                            if (intentos >= 3) {
                                intentos = 0;
                                let idCorrecto = Object.keys(municipiosAPC).find(id => municipiosAPC[id] === municipioActual);
                                let correctoElemento = document.querySelector(`path[id*='${idCorrecto}']`);
                                if (correctoElemento) correctoElemento.classList.add("highlight");

                                setTimeout(() => {
                                    correctoElemento.classList.remove("highlight");
                                    combo = 0;
                                    document.getElementById("combo").innerText = combo;
                                    localStorage.setItem("combo", combo);
                                    siguientePregunta();
                                }, 3000);
                            }
                        }
                    });
                    if (municipioActual) document.getElementById("pregunta").innerText = `Haz clic en: ${municipioActual}`;
                    else siguientePregunta();
                });
            }).catch(error => console.error("Error cargando el mapa:", error));
    </script>

</body>
</html>
