<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trivia APC Madrid</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; background: #f4f4f4; transition: background 0.3s; }
        .dark-mode { background: #222; color: #fff; }
        svg { width: 90vw; height: auto; margin: auto; display: block; }
        .apc { fill: lightgray; stroke: black; stroke-width: 0.5px; cursor: pointer; transition: fill 0.3s ease, transform 0.2s ease; }
        .correct { fill: green !important; }
        .incorrect { fill: red !important; }
        .highlight { fill: yellow !important; }
        .hidden { display: none; }
        button { padding: 10px; margin: 10px; cursor: pointer; }
    </style>
</head>
<body>

    <h1>Trivia APC Madrid</h1>
    <h2 id="question">Cargando...</h2>
    <p>Puntuación: <span id="score">0</span> | Aciertos seguidos: <span id="combo">0</span></p>
    <button onclick="toggleDarkMode()">🌙 Modo oscuro</button>
    <button onclick="reset()">Reset</button>
    <div id="map-container"></div>
    <p id="logro" class="hidden">🏆 ¡Logro desbloqueado!</p>

    <script>
        const codes = [...]; // Lista de códigos (mantenida igual)
        const names = [...]; // Lista de nombres (mantenida igual)

        if (localStorage.getItem("dark-mode") === "true") {
            document.body.classList.add("dark-mode");
        }

        let tries = 0;
        let score = localStorage.getItem("score") || 0;
        let combo = localStorage.getItem("combo") || 0;
        let left = JSON.parse(localStorage.getItem("left")) || [...names].sort(() => Math.random() - 0.5);
        let current = localStorage.getItem("current");
        let blockClicks = false;

        document.getElementById("score").innerText = score;
        document.getElementById("combo").innerText = combo;

        function next() {
            if (left.length > 0) {
                tries = 0;
                current = left.pop();
                localStorage.setItem("current", current);
                document.getElementById("question").innerText = `Haz clic en: ${current}`;
                localStorage.setItem("left", JSON.stringify(left));
                blockClicks = false;
            } else {
                document.getElementById("question").innerText = "¡Juego terminado!";
            }
        }

        function toggleDarkMode() {
            let isDark = document.body.classList.toggle("dark-mode");
            localStorage.setItem("dark-mode", isDark ? "true" : "false");
        }

        function reset() {
            localStorage.setItem("score", score = 0);
            localStorage.setItem("combo", combo = 0);
            left = names.sort(() => Math.random() - 0.5);
            document.getElementById("score").innerText = score;
            document.getElementById("combo").innerText = combo;
            next();
        }

        function mostrarLogro(msg) {
            let logro = document.getElementById("logro");
            logro.innerText = msg;
            logro.classList.remove("hidden");
            setTimeout(() => logro.classList.add("hidden"), 3000);
        }

        fetch("mapa.svg")
            .then(response => response.text())
            .then(svgData => {
                requestIdleCallback(() => {
                    document.getElementById("map-container").innerHTML = svgData;
                    let svg = d3.select("#map-container svg");
                    svg.selectAll("path").filter(function() {
                        return codes.includes(this.getAttribute("id")?.substring(0, 5));
                    }).classed("apc", true);

                    svg.on("click", function(event) {
                        if (blockClicks) return;

                        let target = event.target;
                        let selected = target.getAttribute("id")?.substring(0, 5);

                        if (!selected || !codes.includes(selected)) return;

                        if (names[codes.indexOf(selected)] === current) {
                            target.classList.add("correct");
                            score++;
                            combo++;

                            if (combo === 10) mostrarLogro("🏆 Experto: 10 aciertos seguidos");

                            document.getElementById("score").innerText = score;
                            document.getElementById("combo").innerText = combo;
                            localStorage.setItem("score", score);
                            localStorage.setItem("combo", combo);

                            if ("vibrate" in navigator) navigator.vibrate(100);
                            new Audio("acierto.mp3").play();

                            blockClicks = true;
                            setTimeout(() => {
                                target.classList.remove("correct");
                                next();
                            }, 3000);
                        } else {
                            tries++;
                            target.classList.add("incorrect");
                            if ("vibrate" in navigator) navigator.vibrate(300);
                            new Audio("error.mp3").play();

                            setTimeout(() => target.classList.remove("incorrect"), 2000);

                            if (tries >= 3) {
                                tries = 0;
                                blockClicks = true;
                                let correct = codes[names.indexOf(current)];
                                let cPath = document.querySelector(`path[id*='${correct}']`);
                                if (cPath) cPath.classList.add("highlight");

                                setTimeout(() => {
                                    cPath.classList.remove("highlight");
                                    combo = 0;
                                    document.getElementById("combo").innerText = combo;
                                    localStorage.setItem("combo", combo);
                                    next();
                                }, 3000);
                            }
                        }
                    });

                    if (current) document.getElementById("question").innerText = `Haz clic en: ${current}`;
                    else next();
                });
            }).catch(error => console.error("Error cargando el mapa:", error));
    </script>

</body>
</html>
